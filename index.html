<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é“¶è¡Œæ™ºèƒ½æŠ•é¡¾åŠ©æ‰‹</title>
  <meta name="description" content="ä¸€ä¸ªç”¨äºæ¼”ç¤ºçš„é“¶è¡Œæ™ºèƒ½æŠ•é¡¾èŠå¤©åŠ©æ‰‹å‰ç«¯é¡µé¢ï¼ˆæ— åå°ï¼‰" />
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #ffffff;
      --text: #1f2937;
      --subtle: #6b7280;
      --primary: #155eef; /* é“¶è¡Œä¸šè“ */
      --primary-600: #1f49c6;
      --accent: #10b981; /* å»ºè®®/æ­£å‘ */
      --danger: #ef4444; /* é£é™©æç¤º */
      --border: #e5e7eb;
      --user: #edf2ff;
      --bot: #f1f5f9;
      --chip: #eef2ff;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, #eaf0ff, transparent),
                  radial-gradient(1000px 500px at 110% -10%, #e8fff7, transparent),
                  var(--bg);
    }

    .app-shell {
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,0.8);
      backdrop-filter: saturate(180%) blur(14px);
      border-bottom: 1px solid var(--border);
    }

    .nav {
      max-width: 1080px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: linear-gradient(145deg, var(--primary), #4895ff);
      display: grid;
      place-items: center;
      color: white;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .title {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .title b { font-size: 16px; }
    .title span { font-size: 12px; color: var(--subtle); }

    .nav-actions { display: flex; align-items: center; gap: 8px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      transition: all .15s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,0,0,0.06); }
    .btn-primary { border-color: transparent; background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-600); }

    main {
      flex: 1;
    }

    .container {
      max-width: 960px;
      margin: 18px auto 20px;
      padding: 0 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .hero {
      background: linear-gradient(180deg, #ffffff, #f9fbff);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .hero h1 {
      margin: 0;
      font-size: 20px;
    }

    .hero p {
      margin: 0;
      color: var(--subtle);
      font-size: 14px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      background: var(--chip);
      color: #1e3a8a;
      border: 1px dashed #c7d2fe;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      transition: background .15s ease;
    }
    .chip:hover { background: #e1e7ff; }

    .chat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      min-height: 55vh;
      max-height: 70vh;
      overflow: hidden;
    }

    .messages {
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }

    .msg {
      display: grid;
      grid-template-columns: 40px 1fr;
      gap: 10px;
      align-items: flex-start;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-weight: 700;
      color: white;
    }
    .avatar-bot { background: linear-gradient(145deg, #1e40af, #155eef); }
    .avatar-user { background: linear-gradient(145deg, #0ea5e9, #0369a1); }

    .bubble {
      border: 1px solid var(--border);
      background: var(--bot);
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .bubble.user { background: var(--user); }

    .meta {
      margin-top: 6px;
      font-size: 12px;
      color: var(--subtle);
    }

    .alloc-table {
      margin-top: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .alloc-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .alloc-table th,
    .alloc-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    .alloc-table tr:last-child td { border-bottom: none; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 12px;
      border-radius: 999px;
      background: #ecfeff;
      color: #0e7490;
      border: 1px solid #cffafe;
    }

    .hint {
      font-size: 12px;
      color: var(--subtle);
    }

    .composer {
      border-top: 1px solid var(--border);
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      background: #fff;
    }

    .input-wrap {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    textarea {
      width: 100%;
      resize: none;
      min-height: 48px;
      max-height: 180px;
      padding: 12px 44px 12px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      outline: none;
      transition: border .15s ease, box-shadow .15s ease;
    }
    textarea:focus { border-color: #b7c7ff; box-shadow: 0 0 0 4px #e6ecff; }

    .send {
      align-self: end;
      height: 48px;
      padding: 0 16px;
    }

    .textarea-actions {
      position: absolute;
      right: 8px;
      top: 8px;
      display: flex;
      gap: 6px;
    }

    .link { color: var(--primary); text-decoration: none; }

    .loader {
      display: inline-flex;
      gap: 4px;
      vertical-align: middle;
    }
    .dot {
      width: 6px; height: 6px; border-radius: 50%; background: #64748b; opacity: .6;
      animation: bounce 1s infinite ease-in-out;
    }
    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: .5; }
      40% { transform: translateY(-4px); opacity: 1; }
    }

    details {
      margin-top: 8px;
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 12px;
    }

    footer {
      max-width: 960px;
      margin: 8px auto 24px;
      padding: 0 16px;
      color: var(--subtle);
      font-size: 12px;
    }

    @media (min-width: 860px) {
      .hero { grid-template-columns: 1.2fr .8fr; align-items: center; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="nav">
        <div class="brand">
          <div class="logo" aria-hidden="true">ğŸ¦</div>
          <div class="title">
            <b>æ™ºèƒ½æŠ•é¡¾åŠ©æ‰‹</b>
            <span>Bank Advisory â€¢ æ¼”ç¤ºç‰ˆï¼ˆä»…ä¾›å‚è€ƒï¼‰</span>
          </div>
        </div>
        <div class="nav-actions">
          <button id="clearBtn" class="btn" title="æ¸…ç©ºå¯¹è¯">ğŸ§¹ æ¸…ç©º</button>
          <button id="exportBtn" class="btn" title="å¯¼å‡ºèŠå¤©è®°å½•">â¬‡ï¸ å¯¼å‡º</button>
          <button id="newChatBtn" class="btn btn-primary" title="æ–°å¯¹è¯">ï¼‹ æ–°å¯¹è¯</button>
        </div>
      </div>
    </header>

    <main>
      <div class="container">
        <section class="hero" aria-label="å¼•å¯¼åŒº">
          <div>
            <h1>æ¬¢è¿ä½¿ç”¨é“¶è¡Œæ™ºèƒ½æŠ•é¡¾åŠ©æ‰‹</h1>
            <p>è¯´æ˜ï¼šæœ¬é¡µé¢ä»…ç”¨äºæ¼”ç¤ºå‰ç«¯äº¤äº’ï¼Œæ— åå°æ•°æ®æ¥å…¥ã€‚å›å¤åŸºäºç®€å•è§„åˆ™å¼•æ“ï¼Œéå®é™…æŠ•é¡¾å»ºè®®ã€‚</p>
            <div style="margin-top: 10px" class="hint">å¯ä»¥ä»ä¸‹æ–¹ç¤ºä¾‹æé—®å¼€å§‹ï¼š</div>
            <div class="chips" style="margin-top: 6px;">
              <span class="chip" data-fill="æˆ‘åå¥½ç¨³å¥ï¼Œç†è´¢æœŸé™3å¹´ï¼Œç›®æ ‡å¹´åŒ–4%ï¼Œé¢„ç®—20ä¸‡å…ƒï¼Œä¸»è¦è€ƒè™‘æ•™è‚²é‡‘">ç¨³å¥å‹ Â· 3å¹´ Â· å¹´åŒ–4%</span>
              <span class="chip" data-fill="å¸®æˆ‘åˆ¶å®šETFå®šæŠ•è®¡åˆ’ï¼ŒæœŸé™5å¹´ï¼Œæ¯æœˆ5000å…ƒï¼Œæ³¢åŠ¨å¯æ¥å—">ETF å®šæŠ• Â· 5å¹´ Â· æ¯æœˆ5000</span>
              <span class="chip" data-fill="æˆ‘æƒ³è¦é«˜æµåŠ¨æ€§ã€ä½é£é™©çš„ç°é‡‘ç®¡ç†æ–¹æ¡ˆï¼Œé¢„ç®—10ä¸‡å…ƒ">ç°é‡‘ç®¡ç† Â· ä½é£é™© Â· 10ä¸‡</span>
              <span class="chip" data-fill="æ¿€è¿›ä¸€äº›ï¼Œå…³æ³¨ç§‘æŠ€ä¸»é¢˜åŸºé‡‘ï¼ŒæœŸé™2-3å¹´">ä¸»é¢˜åŸºé‡‘ Â· æ¿€è¿› Â· 2-3å¹´</span>
            </div>
          </div>
          <div>
            <div class="alloc-table">
              <table aria-label="ç¤ºä¾‹èµ„äº§é…ç½®è¡¨">
                <thead>
                  <tr>
                    <th>èµ„äº§ç±»åˆ«</th>
                    <th>å æ¯”</th>
                    <th>ç‰¹å¾</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>ç°é‡‘åŠè´§åŸº</td>
                    <td>10% - 30%</td>
                    <td><span class="badge">é«˜æµåŠ¨æ€§</span></td>
                  </tr>
                  <tr>
                    <td>å€ºåˆ¸/å›ºæ”¶+</td>
                    <td>30% - 60%</td>
                    <td><span class="badge">ç¨³å¥æ”¶ç›Š</span></td>
                  </tr>
                  <tr>
                    <td>è‚¡ç¥¨/æƒç›Š</td>
                    <td>10% - 50%</td>
                    <td><span class="badge">æ³¢åŠ¨è¾ƒé«˜</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="hint" style="margin-top: 8px">ä»…ä¸ºç¤ºä¾‹èŒƒå›´ï¼ŒçœŸå®é…ç½®éœ€ç»“åˆé£é™©åå¥½ã€æœŸé™ä¸ç›®æ ‡ã€‚</div>
          </div>
        </section>

        <section class="chat-card" aria-label="èŠå¤©">
          <div id="messages" class="messages" role="log" aria-live="polite"></div>

          <div class="composer">
            <div class="input-wrap">
              <label for="prompt" class="hint">è¯·è¾“å…¥æŠ•èµ„éœ€æ±‚ï¼ˆä¾‹å¦‚ï¼šæˆ‘åå¥½ç¨³å¥ï¼ŒæœŸé™3å¹´ï¼Œç›®æ ‡å¹´åŒ–4%ï¼‰ï¼š</label>
              <textarea id="prompt" rows="1" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæˆ‘é¢„ç®—30ä¸‡ï¼ŒæœŸæœ›ç¨³å¥å¢å€¼ï¼Œç†è´¢æœŸé™2-3å¹´â€¦"></textarea>
              <div class="textarea-actions">
                <button id="suggestBtn" class="btn" title="æ’å…¥ç¤ºä¾‹">âœ¨ ç¤ºä¾‹</button>
              </div>
            </div>
            <button id="sendBtn" class="btn btn-primary send">å‘é€</button>
          </div>
        </section>
      </div>
    </main>

    <footer>
      é£é™©æç¤ºï¼šæœ¬å·¥å…·ä¸ºæ¼”ç¤ºç”¨é€”ï¼Œå†…å®¹ä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®æˆ–æ”¶ç›Šæ‰¿è¯ºã€‚å¸‚åœºæœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚å¦‚éœ€ä¸ªæ€§åŒ–æ–¹æ¡ˆï¼Œè¯·è”ç³»æŒç‰ŒæŠ•é¡¾å¹¶ä»¥å®˜æ–¹åˆè§„æ–‡ä»¶ä¸ºå‡†ã€‚
    </footer>
  </div>

  <script>
    // ---- ç®€å•å·¥å…·å‡½æ•° ----
    const $ = (sel) => document.querySelector(sel);
    const nowTime = () => new Date().toLocaleString();

    function autoGrow(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 180) + 'px';
    }

    function scrollToBottom(container) {
      container.scrollTop = container.scrollHeight + 200;
    }

    function download(filename, text) {
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }

    // ---- ç®€å•æœ¬åœ°â€œå¯¹è¯å­˜å‚¨â€ ----
    const STORAGE_KEY = 'bank_advisor_chat_v1';

    function loadHistory() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
    }

    function saveHistory(messages) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    }

    // ---- è§„åˆ™å¼•æ“ï¼šä»æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯å¹¶ç”Ÿæˆå»ºè®® ----
    function parseUserIntent(text) {
      const normalized = text.replace(/\s+/g, '').toLowerCase();

      // é£é™©åå¥½
      let risk = 'å¹³è¡¡';
      if (/ä¿å®ˆ|ä½é£é™©|ç¨³å¥|ä½æ³¢åŠ¨/.test(text)) risk = 'ç¨³å¥';
      if (/æ¿€è¿›|é«˜é£é™©|è¿›å–|è¿›é˜¶/.test(text)) risk = 'æ¿€è¿›';
      if (/å¹³è¡¡|ä¸­ç­‰|é€‚ä¸­/.test(text)) risk = 'å¹³è¡¡';

      // æœŸé™ï¼ˆæŒ‰æœˆä¼°ç®—ï¼‰
      let months = null;
      const yearMatch = text.match(/(\d+(?:\.\d+)?)\s*å¹´/);
      const monthMatch = text.match(/(\d+(?:\.\d+)?)\s*ä¸ªæœˆ/);
      const rangeMatch = text.match(/(\d+(?:\.\d+)?)\s*[-~åˆ°]\s*(\d+(?:\.\d+)?)\s*å¹´/);
      if (rangeMatch) {
        months = Math.round(((parseFloat(rangeMatch[1]) + parseFloat(rangeMatch[2])) / 2) * 12);
      } else if (yearMatch) {
        months = Math.round(parseFloat(yearMatch[1]) * 12);
      } else if (monthMatch) {
        months = Math.round(parseFloat(monthMatch[1]));
      }

      // é¢„ç®—é‡‘é¢ï¼ˆäººæ°‘å¸ï¼‰
      let budget = null;
      const budgetMatch = text.match(/(\d+(?:\.\d+)?)\s*(?:ä¸‡|ä¸‡å…ƒ|w)/i);
      const yuanMatch = text.match(/(\d{4,})\s*(?:å…ƒ|rmb|äººæ°‘å¸)?/i);
      if (budgetMatch) {
        budget = parseFloat(budgetMatch[1]) * 10000;
      } else if (yuanMatch) {
        budget = parseFloat(yuanMatch[1]);
      }

      // å®šæŠ•ï¼ˆæ¯æœˆæŠ•å…¥ï¼‰
      let sipMonthly = null;
      const sipMatch = text.match(/æ¯æœˆ\s*(\d+(?:\.\d+)?)\s*(?:å…ƒ|rmb)?/);
      if (sipMatch) sipMonthly = parseFloat(sipMatch[1]);
      const sipWan = text.match(/æ¯æœˆ\s*(\d+(?:\.\d+)?)\s*(?:ä¸‡|ä¸‡å…ƒ)/);
      if (sipWan) sipMonthly = parseFloat(sipWan[1]) * 10000;

      // ç›®æ ‡å¹´åŒ–æ”¶ç›Š
      let targetAnnual = null;
      const ann = text.match(/å¹´åŒ–\s*(\d+(?:\.\d+)?)\s*%/);
      if (ann) targetAnnual = parseFloat(ann[1]);

      // ä¸»é¢˜ä¸åå¥½å…³é”®è¯
      const interests = [];
      if (/etf|æŒ‡æ•°|å®½åŸº/.test(normalized)) interests.push('ETF/æŒ‡æ•°');
      if (/ç§‘æŠ€|å…ˆè¿›åˆ¶é€ |åŠå¯¼ä½“|ai|æ–°èƒ½æº|æ•°å­—ç»æµ/.test(text)) interests.push('ç§‘æŠ€ä¸»é¢˜');
      if (/ç°é‡‘|è´§å¸|ä½™[é¢]å®|é«˜æµåŠ¨æ€§|ç°é‡‘ç®¡ç†/.test(text)) interests.push('ç°é‡‘ç®¡ç†');
      if (/å€ºåˆ¸|å›ºæ”¶|é€†å›è´­/.test(text)) interests.push('å›ºæ”¶');
      if (/å…»è€|é€€ä¼‘/.test(text)) interests.push('å…»è€');
      if (/æ•™è‚²|å­å¥³/.test(text)) interests.push('æ•™è‚²é‡‘');
      if (/ä¹°æˆ¿|æˆ¿è´·|é¦–ä»˜/.test(text)) interests.push('ç½®ä¸š');

      return { risk, months, budget, sipMonthly, targetAnnual, interests };
    }

    function buildAllocation(riskLevel, months, interests) {
      // åŸºäºé£é™©ä¸æœŸé™çš„ç®€å•æ˜ å°„
      const longTerm = months != null ? months >= 36 : true;
      let cash = 15, bond = 45, equity = 40; // å¹³è¡¡é»˜è®¤
      if (riskLevel === 'ç¨³å¥') {
        cash = longTerm ? 20 : 30;
        bond = longTerm ? 55 : 50;
        equity = 100 - cash - bond;
      } else if (riskLevel === 'æ¿€è¿›') {
        cash = longTerm ? 10 : 15;
        bond = longTerm ? 25 : 35;
        equity = 100 - cash - bond;
      }

      // å…´è¶£åå¥½åŠ ç‚¹å¾®è°ƒ
      if (interests.includes('ç°é‡‘ç®¡ç†')) { cash = Math.min(40, cash + 10); bond = Math.max(10, bond - 5); equity = 100 - cash - bond; }
      if (interests.includes('ETF/æŒ‡æ•°')) { equity = Math.min(70, equity + 5); bond = Math.max(10, bond - 3); cash = 100 - equity - bond; }
      if (interests.includes('å›ºæ”¶')) { bond = Math.min(70, bond + 8); equity = Math.max(5, equity - 6); cash = 100 - equity - bond; }

      return { cash, bond, equity };
    }

    function formatCurrency(cny) {
      if (cny == null) return 'â€”';
      if (cny >= 10000) return (cny/10000).toFixed(2).replace(/\.00$/, '') + ' ä¸‡å…ƒ';
      return Math.round(cny).toLocaleString('zh-CN') + ' å…ƒ';
    }

    function generateAdvice(intel) {
      const { risk, months, budget, sipMonthly, targetAnnual, interests } = intel;
      const alloc = buildAllocation(risk, months, interests);

      const horizonText = months != null ? (months >= 12 ? (months/12).toFixed(1).replace(/\.0$/, '') + ' å¹´' : months + ' ä¸ªæœˆ') : 'æœªæŒ‡å®š';
      const interestText = interests.length ? interests.join('ã€') : 'â€”';

      const recommendations = [];

      // æ–¹æ¡ˆ 1ï¼šç»¼åˆé…ç½®
      recommendations.push({
        title: 'ç»¼åˆèµ„äº§é…ç½®æ–¹æ¡ˆ',
        summary: 'æŒ‰é£é™©ä¸æœŸé™ç»™å‡ºç°é‡‘/å›ºæ”¶/æƒç›Šçš„åŸºå‡†æ¯”ä¾‹ï¼Œå¹¶å¯æŒ‰ä¸»é¢˜åå¥½å¾®è°ƒã€‚',
        lines: [
          `ç›®æ ‡é£é™©ï¼š${risk}ï¼›æŠ•èµ„æœŸé™ï¼š${horizonText}`,
          `åå¥½ä¸»é¢˜ï¼š${interestText}ï¼›é¢„ç®—ï¼š${formatCurrency(budget)}${sipMonthly ? `ï¼›æ¯æœˆå®šæŠ•ï¼š${formatCurrency(sipMonthly)}` : ''}`,
          `ç›®æ ‡å¹´åŒ–ï¼š${targetAnnual != null ? targetAnnual + '%ï¼ˆè‡ªå®šç›®æ ‡ï¼‰' : 'æœªè®¾å®š'}`
        ],
        table: [
          ['ç°é‡‘åŠè´§å¸ç±»', alloc.cash + '%', 'åº”æ€¥/æµåŠ¨æ€§ç®¡ç†'],
          ['å€ºåˆ¸/å›ºæ”¶+', alloc.bond + '%', 'ç¨³å¥æ”¶ç›ŠåŸºçŸ³'],
          ['è‚¡ç¥¨/æƒç›Šç±»', alloc.equity + '%', 'ä¸­é•¿æœŸå¢å€¼æ¥æº']
        ]
      });

      // æ–¹æ¡ˆ 2ï¼šä¸»é¢˜å¢å¼º
      if (interests.includes('ETF/æŒ‡æ•°') || interests.includes('ç§‘æŠ€ä¸»é¢˜')) {
        recommendations.push({
          title: 'ä¸»é¢˜/æŒ‡æ•°å¢å¼ºæ–¹æ¡ˆ',
          summary: 'åˆ©ç”¨å®½åŸº+è¡Œä¸š/ä¸»é¢˜ETFåšâ€œæ ¸å¿ƒ-å«æ˜Ÿâ€é…ç½®ï¼Œæ§åˆ¶å•ä¸»é¢˜æš´éœ²ã€‚',
          lines: [
            'æ ¸å¿ƒï¼šæ²ªæ·±300/ä¸­è¯500/ä¸­è¯å…¨æŒ‡ ç­‰å®½åŸºæŒ‡æ•°ï¼›',
            'å«æ˜Ÿï¼šç§‘æŠ€/æ–°èƒ½æº/é«˜ç«¯åˆ¶é€  ä¸»é¢˜ETF ä¸è¶…è¿‡æƒç›Šçš„30%-40%ã€‚'
          ],
          table: [
            ['æ ¸å¿ƒï¼ˆå®½åŸºETFï¼‰', 'æƒç›Šçš„ 60%-70%', 'åˆ†æ•£å¸‚åœº Beta'],
            ['å«æ˜Ÿï¼ˆä¸»é¢˜ETFï¼‰', 'æƒç›Šçš„ 30%-40%', 'è·å–è¶…é¢æ”¶ç›Šæœºä¼š'],
            ['æ­¢æŸä¸å†å¹³è¡¡', 'å­£åº¦/åŠå¹´åº¦', 'çºªå¾‹æ€§ç®¡ç†æ³¢åŠ¨']
          ]
        });
      }

      // æ–¹æ¡ˆ 3ï¼šç°é‡‘ç®¡ç†
      if (interests.includes('ç°é‡‘ç®¡ç†') || (months != null && months <= 6)) {
        recommendations.push({
          title: 'ç°é‡‘ä¸æµåŠ¨æ€§ç®¡ç†æ–¹æ¡ˆ',
          summary: 'å¼ºè°ƒæµåŠ¨æ€§ä¸æœ¬é‡‘å®‰å…¨ï¼Œé€‚åˆçŸ­æœŸæˆ–éšæ—¶å¯ç”¨é¢„ç®—ã€‚',
          lines: [
            'å·¥å…·ï¼šè´§å¸åŸºé‡‘ã€çŸ­å€ºåŸºé‡‘ã€é“¶è¡Œæ™ºèƒ½å­˜æ¬¾ã€é€†å›è´­ç­‰ï¼›',
            'ç›®æ ‡ï¼šåœ¨ç¡®ä¿æµåŠ¨æ€§çš„å‰æä¸‹ï¼ŒåŠ›äº‰ä¼˜äºæ´»æœŸçš„ç¨³å¥æ”¶ç›Šã€‚'
          ],
          table: [
            ['è´§å¸/ç°é‡‘ç±»', '50%-80%', 'T+0/T+1 èµå›ï¼ŒæµåŠ¨æ€§é«˜'],
            ['çŸ­å€º/å›ºæ”¶+', '20%-50%', 'æ³¢åŠ¨è¾ƒå°ï¼Œæ”¶ç›Šç•¥é«˜'],
            ['æé†’', 'â€”', 'å…³æ³¨æµåŠ¨æ€§è§„åˆ™ä¸èµå›é™åˆ¶']
          ]
        });
      }

      if (recommendations.length === 0) {
        recommendations.push({
          title: 'åŸºç¡€é…ç½®å‚è€ƒ',
          summary: 'ç¼ºå°‘åå¥½ç»†èŠ‚æ—¶ï¼Œæä¾›é€šç”¨çš„é£é™©åˆ†å±‚é…ç½®ä½œä¸ºå‚è€ƒã€‚',
          lines: ['å¯è¡¥å……ï¼šé£é™©åå¥½ã€æœŸé™ã€é¢„ç®—ã€ä¸»é¢˜åå¥½ç­‰ä¿¡æ¯ï¼Œä»¥è·å¾—æ›´ç²¾å‡†å»ºè®®ã€‚'],
          table: [
            ['ç°é‡‘åŠè´§å¸ç±»', '20%-30%', 'åº”æ€¥ä¸çŸ­æœŸæ”¯å‡º'],
            ['å€ºåˆ¸/å›ºæ”¶+', '40%-50%', 'ç¨³å¥æ”¶ç›Šåº•åº§'],
            ['è‚¡ç¥¨/æƒç›Šç±»', '20%-40%', 'ä¸­é•¿æœŸæˆé•¿']
          ]
        });
      }

      return { alloc, recommendations, risk, horizonText, budgetText: formatCurrency(budget) };
    }

    // ---- æ¸²æŸ“å‡½æ•° ----
    function createMessageElement(role, htmlContent) {
      const wrapper = document.createElement('div');
      wrapper.className = 'msg';
      const avatar = document.createElement('div');
      avatar.className = 'avatar ' + (role === 'assistant' ? 'avatar-bot' : 'avatar-user');
      avatar.textContent = role === 'assistant' ? 'B' : 'æˆ‘';

      const bubble = document.createElement('div');
      bubble.className = 'bubble' + (role === 'user' ? ' user' : '');
      bubble.innerHTML = htmlContent;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = nowTime();

      const right = document.createElement('div');
      right.appendChild(bubble);
      right.appendChild(meta);

      wrapper.appendChild(avatar);
      wrapper.appendChild(right);

      return wrapper;
    }

    function renderAdvice(advice) {
      const { recommendations } = advice;
      const blocks = recommendations.map(rec => {
        const rows = rec.table.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`).join('');
        const lines = rec.lines.map(l => `<li>${l}</li>`).join('');
        return `
          <div style="margin-top:6px">
            <div style="font-weight:700">${rec.title}</div>
            <div class="hint" style="margin:6px 0 4px">${rec.summary}</div>
            <ul style="margin:0 0 6px 18px; padding:0">${lines}</ul>
            <div class="alloc-table">
              <table>
                <thead>
                  <tr><th>ç±»åˆ«</th><th>å»ºè®®å æ¯”</th><th>è¯´æ˜</th></tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');

      const disclaimer = `
        <details>
          <summary>é‡è¦è¯´æ˜ä¸é£é™©æç¤º</summary>
          <div class="hint" style="margin-top:6px">
            æœ¬å›å¤åŸºäºå…³é”®è¯è§„åˆ™ç”Ÿæˆï¼Œä¸ä»£è¡¨çœŸå®æŠ•é¡¾æ„è§ï¼Œä¹Ÿä¸æ„æˆæŠ•èµ„å»ºè®®æˆ–æ”¶ç›Šæ‰¿è¯ºã€‚å¸‚åœºæœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚è¯·ç»“åˆè‡ªèº«æƒ…å†µï¼Œå¹¶ä»¥å®˜æ–¹åˆè§„æ–‡ä»¶ä¸æŠ«éœ²ä¸ºå‡†ã€‚
          </div>
        </details>
      `;

      return blocks + disclaimer;
    }

    // ---- äº‹ä»¶ä¸ä¸»é€»è¾‘ ----
    const messagesEl = $('#messages');
    const inputEl = $('#prompt');
    const sendBtn = $('#sendBtn');

    function pushMessage(role, html) {
      const node = createMessageElement(role, html);
      messagesEl.appendChild(node);
      scrollToBottom(messagesEl);
      return node;
    }

    function showThinking() {
      return pushMessage('assistant', `æ­£åœ¨åˆ†æ <span class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`);
    }

    function replaceMessageContent(msgNode, html) {
      const bubble = msgNode.querySelector('.bubble');
      if (bubble) bubble.innerHTML = html;
    }

    function onSend() {
      const text = inputEl.value.trim();
      if (!text) return;

      // è¿½åŠ ç”¨æˆ·æ¶ˆæ¯
      pushMessage('user', escapeHtml(text));

      inputEl.value = '';
      autoGrow(inputEl);

      // æ€è€ƒä¸­å ä½
      const thinkingNode = showThinking();

      // æ¨¡æ‹Ÿå¤„ç†è€—æ—¶
      setTimeout(() => {
        const intel = parseUserIntent(text);
        const advice = generateAdvice(intel);
        const html = renderAdvice(advice);
        replaceMessageContent(thinkingNode, html);
        persistFromDOM();
      }, 650);

      persistFromDOM();
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function persistFromDOM() {
      const items = Array.from(messagesEl.querySelectorAll('.msg')).map(msg => {
        const isAssistant = msg.querySelector('.avatar-bot') != null;
        const html = msg.querySelector('.bubble')?.innerHTML || '';
        return { role: isAssistant ? 'assistant' : 'user', html };
      });
      saveHistory(items);
    }

    function restoreFromStorage() {
      const items = loadHistory();
      if (items.length === 0) {
        // åˆå§‹æ¬¢è¿è¯­
        pushMessage('assistant', 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯é“¶è¡Œæ™ºèƒ½æŠ•é¡¾åŠ©æ‰‹ã€‚è¯·æè¿°æ‚¨çš„æŠ•èµ„éœ€æ±‚ï¼Œä¾‹å¦‚é£é™©åå¥½ã€ç›®æ ‡å¹´åŒ–ã€æŠ•èµ„æœŸé™ä¸é¢„ç®—ç­‰ï¼Œæˆ‘å°†ä¸ºæ‚¨ç»™å‡ºå‚è€ƒé…ç½®ã€‚');
        return;
      }
      items.forEach(m => pushMessage(m.role, m.html));
    }

    // ç»‘å®šäº‹ä»¶
    sendBtn.addEventListener('click', onSend);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        onSend();
      }
    });

    inputEl.addEventListener('input', () => autoGrow(inputEl));
    window.addEventListener('load', () => autoGrow(inputEl));

    $('#clearBtn').addEventListener('click', () => {
      if (!confirm('ç¡®è®¤æ¸…ç©ºå¯¹è¯ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
      localStorage.removeItem(STORAGE_KEY);
      messagesEl.innerHTML = '';
      restoreFromStorage();
    });

    $('#exportBtn').addEventListener('click', () => {
      const data = loadHistory();
      const exportText = data.map(d => `[${d.role === 'assistant' ? 'åŠ©æ‰‹' : 'ç”¨æˆ·'}] ${d.html.replace(/<[^>]*>/g, '')}`).join('\n\n');
      download('chat_export.txt', exportText);
    });

    $('#newChatBtn').addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY);
      messagesEl.innerHTML = '';
      restoreFromStorage();
    });

    $('#suggestBtn').addEventListener('click', () => {
      inputEl.value = 'æˆ‘åå¥½å¹³è¡¡ï¼Œé¢„ç®—30ä¸‡å…ƒï¼Œç†è´¢æœŸé™3-5å¹´ï¼Œç›®æ ‡å¹´åŒ–5%ï¼Œå¹¶å¸Œæœ›æ¯æœˆå®šæŠ•3000å…ƒ';
      autoGrow(inputEl);
      inputEl.focus();
    });

    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        inputEl.value = chip.getAttribute('data-fill') || chip.textContent;
        autoGrow(inputEl);
        inputEl.focus();
      });
    });

    // é¦–æ¬¡æ¸²æŸ“
    restoreFromStorage();
  </script>
</body>
</html>